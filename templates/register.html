<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MOLI 門禁註冊</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>

<body>
  <div class="page-wrap">
    <header class="moli-header">
      <div class="brand">
        <span class="brand-mark"></span>
        <span>MOLI 門禁系統</span>
      </div>
      <div class="lab-tag">Makers' Open Lab for Innovation</div>
    </header>

    <main class="main-center">
      <div class="card">
        <div class="card-title">進出門禁註冊</div>
        <div class="card-subtitle">
          請先填寫學號與姓名，送出後依畫面指示刷學生證完成綁定。
        </div>

        <form id="registerForm">
          <label for="student_id">學號</label>
          <input type="text" id="student_id" name="student_id" required />

          <label for="name">姓名</label>
          <input type="text" id="name" name="name" required />

          <button type="submit">送出註冊</button>
          <div class="error" id="errorMsg"></div>
        </form>
      </div>
    </main>
    <footer class="moli-footer">
      © MOLI – Makers' Open Lab for Innovation
    </footer>
  </div>

  <div id="loadingModal" class="loading-modal">
    <div class="loading-card">
      <div class="modal-title" id="modalTitle">資料建立成功</div>

      <div class="spinner" id="loadingSpinner"></div>
      <div class="success-icon" id="successIcon" style="display: none;">✅</div>

      <div class="scan-status" id="scanStatus">
        請在 60 秒內至讀卡機刷卡...
      </div>
    </div>
  </div>

  <script>
    // 接收後端傳來的 ngrok 網址
    const PI_API_URL = "{{ pi_api_url }}";

    document.getElementById("registerForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;
      const student_id = form.student_id.value.trim();
      const name = form.name.value.trim();
      const errorMsg = document.getElementById("errorMsg");

      if (!student_id || !name) return;

      const formData = new FormData();
      formData.append("student_id", student_id);
      formData.append("name", name);

      try {
        // 1. 呼叫 Web Backend 建立資料
        const resp = await fetch("/register", { method: "POST", body: formData });

        if (resp.ok) {
          // 2. 呼叫 Pi 進入註冊模式
          try {
            if (PI_API_URL && PI_API_URL !== "None") {
              const piResp = await fetch(`${PI_API_URL}/mode/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ student_id: student_id })
              });
              if (!piResp.ok) throw new Error("Pi 連線失敗");
            } else {
              console.warn("未設定 PI_API_URL，僅進行網頁模擬");
            }
          } catch (piErr) {
            console.error("讀卡機連線失敗", piErr);
            errorMsg.textContent = "讀卡機連線失敗，請稍後再試";
            return; // 停止流程
          }

          // 3. 顯示倒數視窗並開始輪詢
          document.getElementById("loadingModal").style.display = "block";
          startPolling(student_id);

        } else {
          const errData = await resp.json();
          errorMsg.textContent = errData.detail || "註冊失敗";
        }
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "連線錯誤，請檢查網路";
      }
    });

    function startPolling(student_id) {
      const scanStatus = document.getElementById("scanStatus");
      const spinner = document.getElementById("loadingSpinner");
      const successIcon = document.getElementById("successIcon");
      const modalTitle = document.getElementById("modalTitle");

      let attempts = 0;
      const maxAttempts = 30; // 60秒

      const intervalId = setInterval(async () => {
        attempts++;
        try {
          const res = await fetch(`/check_status/${student_id}`);
          const data = await res.json();

          if (data.bound) {
            clearInterval(intervalId);
            spinner.style.display = "none";
            successIcon.style.display = "block";
            successIcon.style.fontSize = "40px";
            successIcon.style.margin = "10px auto";
            modalTitle.textContent = "綁定完成！";
            modalTitle.style.color = "#22c55e";
            scanStatus.textContent = "歡迎進入 MOLI 實驗室";
            scanStatus.style.fontWeight = "bold";
            scanStatus.style.color = "#22c55e";
            setTimeout(() => {
              window.location.href = `/success?student_id=${encodeURIComponent(student_id)}`;
            }, 1500);
          } else if (data.status === "step_1") {
            scanStatus.textContent = "✅ 讀取成功！請「再次刷卡」確認...";
            scanStatus.style.color = "#2563eb";
            scanStatus.style.fontWeight = "bold";
          } else if (data.status === "error") {
            scanStatus.textContent = data.message || "錯誤，請重新刷卡";
            scanStatus.style.color = "red";
          }

          if (attempts >= maxAttempts) {
            clearInterval(intervalId);
            spinner.style.display = "none";
            scanStatus.textContent = "❌ 刷卡逾時，請重新整理頁面再試。";
            scanStatus.style.color = "red";
          }
        } catch (e) { console.error(e); }
      }, 2000);
    }
  </script>
  
</body>

</html>

